<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>兆观医生绑定关系桑基图</title>
</head>
<body>
  <div id="chart" style="width: 500px;height: 500px;"></div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/4.3.0/echarts.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/leancloud-storage@3.15.0/dist/av-min.js"></script>
<script>
  var myChart = echarts.init(document.getElementById('chart'));
  myChart.showLoading();
  AV.init({
    appId: "f82OcAshk5Q1J993fGLJ4bbs-gzGzoHsz",
    appKey: "O9COJzi78yYXCWVWMkLqlpp8",
    serverURLs: "https://api-mhn.megahealth.cn"
  });
  var query = new AV.Query('DoctorPatientRelation');
  query.include('idPatient.name', 'idDoctor.name')
  query.find().then(function (res) {
    var links = [];
    var nodes = [];

    res.forEach(function(item) {
      var doctorName = item.get('idDoctor')&&item.get('idDoctor').get('name')
      var patientName = item.get('idPatient')&&item.get('idPatient').get('name')
      if(doctorName&&patientName) {
        links.push({
          source: doctorName,
          target: patientName,
          value: 1
        })

        if(nodes.indexOf(doctorName) == -1) {
          nodes.push(doctorName)
        }
        if(nodes.indexOf(patientName) == -1) {
          nodes.push(patientName)
        }
      }
    })
    var arr=[];
    
    nodes.forEach(function(a) {
      arr.push({
        name: a
      })
    })
    var data = {
      links,
      nodes: arr
    };
    console.log(data);
    

    myChart.setOption(option = {
      title: {
        text: 'Sankey Diagram'
      },
      tooltip: {
        trigger: 'item',
        triggerOn: 'mousemove'
      },
      series: [
        {
          type: 'sankey',
          data: data.nodes,
          links: data.links,
          focusNodeAdjacency: 'allEdges',
          itemStyle: {
            normal: {
              borderWidth: 1,
              borderColor: '#aaa'
            }
          },
          lineStyle: {
            normal: {
              color: 'source',
              curveness: 0.5
            }
          }
        }
      ]
    });
    myChart.hideLoading();
  });
</script>
</html>
